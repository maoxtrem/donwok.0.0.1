server {
    listen 80;
    server_name localhost;

    # 1. Mercure - Aquí es donde ocurre la magia del Relay
    location /.well-known/mercure {
        # Si la petición viene del Core (desde la red interna), le inyectamos el Token JWT firmado
        # Usamos una variable para detectar si el origen es el core
        set $auth_header $http_authorization;
        if ($remote_addr ~* "172\..*") { # IP interna de Docker (ajustar si es necesario)
            set $auth_header "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJtZXJjdXJlIjp7InB1Ymxpc2giOlsiKiJdfX0.aG9i0Irajat6mGgko_Xi5pDjNBtLLQLfElq2qbF-Eqg";
        }

        proxy_set_header Authorization $auth_header;
        proxy_pass http://mercure-hub;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Necesario para SSE (Tiempo real)
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;
    }

    # 2. Auth API
    location /api/auth/ {
        proxy_pass http://auth-dev:8000/;
        proxy_set_header Host $host;
    }

    # 3. Core API
    location /api/core/ {
        proxy_pass http://core-dev:8000/;
        proxy_set_header Host $host;
    }

    # 4. Frontend (Por defecto)
    location / {
        proxy_pass http://frontend-symfony:8000;
        proxy_set_header Host $host;
    }
}
