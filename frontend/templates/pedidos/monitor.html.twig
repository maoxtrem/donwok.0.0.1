{% extends 'base.html.twig' %}

{% block title %}Monitor de Pedidos - DonWok{% endblock %}
{% block body_class %}monitor-page{% endblock %}
{% block show_sidebar %}{% endblock %}

{% block stylesheets %}
<style>
    :root {
        --bg-dark: #0f172a;
        --card-pending: rgba(245, 158, 11, 0.1);
        --card-ready: rgba(16, 185, 129, 0.1);
        --accent-amber: #f59e0b;
        --accent-emerald: #10b981;
    }
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: var(--bg-dark); }
    .monitor-container { display: flex; height: 100vh; width: 100vw; }
    .monitor-col { flex: 1; padding: 3rem; display: flex; flex-direction: column; overflow: hidden; }
    .col-pending { background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); border-right: 2px solid rgba(255,255,255,0.05); }
    .col-ready { background: linear-gradient(180deg, #0f172a 0%, #111827 100%); }
    .monitor-header { text-align: center; margin-bottom: 4rem; }
    .monitor-header h1 { font-size: 3.5rem; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; }
    .text-pending { color: var(--accent-amber); text-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
    .text-ready { color: var(--accent-emerald); text-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
    .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 2rem; }
    .order-card { aspect-ratio: 1/1; border-radius: 24px; display: flex; align-items: center; justify-content: center; animation: orderIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; }
    @keyframes orderIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
    .card-pending { background: var(--card-pending); border: 2px solid rgba(245, 158, 11, 0.2); }
    .card-ready { background: var(--card-ready); border: 2px solid rgba(16, 185, 129, 0.2); }
    .order-number { font-size: 5rem; font-weight: 900; color: white; }
    
    #sse-status { position: fixed; top: 1rem; right: 1rem; z-index: 3000; opacity: 0.8; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }

    .btn-back-float { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; text-decoration: none; transition: all 0.3s; z-index: 2000; border: 1px solid rgba(255,255,255,0.1); }
</style>
{% endblock %}

{% block body %}
<div id="sse-status">
    <span class="badge bg-warning text-dark animate-pulse">Conectando...</span>
</div>

<div class="monitor-container">
    <div class="monitor-col col-pending">
        <div class="monitor-header"><h1 class="text-pending">Preparando</h1></div>
        <div id="pending-list" class="orders-grid"></div>
    </div>
    <div class="monitor-col col-ready">
        <div class="monitor-header"><h1 class="text-ready">Listos</h1></div>
        <div id="ready-list" class="orders-grid"></div>
    </div>
</div>
<a href="/dashboard" class="btn-back-float"><i class="bi bi-grid-fill"></i></a>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();

    function updateStatus(text, colorClass) {
        const el = document.getElementById('sse-status');
        if (el) el.innerHTML = `<span class="badge ${colorClass} animate-pulse">${text}</span>`;
    }

    // ðŸŸ¢ Inicializar Mercure (EventSource)
    function startMercure() {
        const url = new URL('/.well-known/mercure', window.location.origin);
        url.searchParams.append('topic', 'donwok/pedidos');

        console.log("[SSE] Conectando a:", url.toString());
        const eventSource = new EventSource(url);

        eventSource.onopen = () => {
            updateStatus('Online âœ…', 'bg-success');
            console.log("[SSE] Conectado.");
        };

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("[SSE] Evento:", data);
            handleIncomingEvent(data);
        };

        eventSource.onerror = (err) => {
            console.error("[SSE] Error:", err);
            updateStatus('Reconectando... âš ï¸', 'bg-warning text-dark');
        };
    }

    // ðŸ”µ Cargar datos iniciales
    async function loadInitialData() {
        try {
            const pedidos = await api.get('/pedidos/pendientes');
            pedidos.forEach(p => {
                if (p.estado === 'PENDIENTE') window.renderOrder(p, 'pending');
                if (p.estado === 'TERMINADO') window.renderOrder(p, 'ready');
            });
        } catch (err) { console.error("Error cargando API:", err); }
    }

    function handleIncomingEvent(data) {
        if (data.type === 'NEW_ORDER') window.renderOrder(data.pedido, 'pending');
        else if (data.type === 'ORDER_READY') window.moveOrder(data.pedido.id);
        else if (data.type === 'ORDER_INVOICED') window.removeOrder(data.pedido.id);
    }

    window.renderOrder = (pedido, type) => {
        if (document.getElementById(`order-${pedido.id}`)) return;
        const grid = type === 'pending' ? document.getElementById('pending-list') : document.getElementById('ready-list');
        const cardClass = type === 'pending' ? 'card-pending' : 'card-ready';
        const card = `<div class="order-card ${cardClass}" id="order-${pedido.id}"><div class="order-number">${pedido.id}</div></div>`;
        grid.insertAdjacentHTML('afterbegin', card);
    };

    window.moveOrder = (id) => {
        const card = document.getElementById(`order-${id}`);
        if (card) { card.remove(); window.renderOrder({id: id}, 'ready'); playSound(); }
    };

    window.removeOrder = (id) => {
        const card = document.getElementById(`order-${id}`);
        if (card) card.remove();
    };

    function playSound() {
        new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(() => {});
    }

    // Arrancar
    startMercure();
    loadInitialData();
</script>
{% endblock %}
