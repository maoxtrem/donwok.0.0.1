{% extends 'base.html.twig' %}

{% block title %}Gesti√≥n de Pedidos - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Cola de Producci√≥n</h2>
            <p class="text-muted">Gesti√≥n de estados en tiempo real</p>
        </div>
        <div id="sse-status-badge">
            <span class="badge bg-secondary">Iniciando SSE...</span>
        </div>
    </div>

    <div class="glass-card shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Nro.</th>
                    <th>Productos</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Estado</th>
                    <th class="pe-4 text-end">Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="production-queue">
                <tr><td colspan="5" class="text-center py-5 text-muted">Cargando cola...</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();

    function updateWSStatus(text, colorClass) {
        const container = document.getElementById('sse-status-badge');
        if (container) container.innerHTML = `<span class="badge ${colorClass} animate-pulse">${text}</span>`;
    }

    // Funciones globales
    window.terminarPedido = async (id) => {
        const btn = document.getElementById(`btn-action-${id}`);
        if (!btn) return;
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        try {
            const res = await api.post(`/pedidos/${id}/terminar`);
            
            // üü¢ Notificaci√≥n de √âxito
            Swal.fire({
                icon: 'success',
                title: '¬°Pedido Terminado!',
                text: `El pedido #${id} est√° listo para entregar.`,
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });

            if (res.pedido) updateOrderRow(res.pedido);
        } catch (err) { 
            btn.disabled = false;
            btn.innerText = originalText;
            
            // üî¥ Notificaci√≥n de Error
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: err.message || 'No se pudo terminar el pedido.'
            });
        }
    };

    window.facturarPedido = async (id) => {
        const btn = document.getElementById(`btn-action-${id}`);
        if (!btn) return;
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        try {
            const res = await api.post(`/pedidos/${id}/facturar`);
            
            // üü¢ Notificaci√≥n de √âxito
            Swal.fire({
                icon: 'success',
                title: '¬°Facturado!',
                text: `Factura ${res.pedido?.numeroFactura || ''} generada correctamente.`,
                timer: 2000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });

            removeOrderRow(id);
        } catch (err) { 
            btn.disabled = false;
            btn.innerText = originalText;
            
            // üî¥ Notificaci√≥n de Error
            Swal.fire({
                icon: 'error',
                title: 'Error al facturar',
                text: err.message || 'Hubo un problema al procesar la factura.'
            });
        }
    };

    async function init() {
        try {
            const pedidos = await api.get('/pedidos/pendientes');
            renderQueue(pedidos);
        } catch (err) { 
            console.error("Error inicial:", err);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexi√≥n',
                text: 'No se pudieron cargar los pedidos iniciales.'
            });
        }

        // Mercure SSE
        const url = new URL('/.well-known/mercure', window.location.origin);
        url.searchParams.append('topic', 'donwok/pedidos');

        const eventSource = new EventSource(url);

        eventSource.onopen = () => {
            console.log("[SSE] Conectado ‚úÖ");
            updateWSStatus('Tiempo Real: Activo ‚úÖ', 'bg-success');
        };

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("[SSE] Evento:", data);
            
            if (data.type === 'NEW_ORDER') {
                prependToQueue(data.pedido);
                // Notificaci√≥n discreta de nuevo pedido
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                audio.play().catch(() => {});
            }
            else if (data.type === 'ORDER_READY') updateOrderRow(data.pedido);
            else if (data.type === 'ORDER_INVOICED') removeOrderRow(data.pedido.id);
        };

        eventSource.onerror = () => {
            updateWSStatus('Reconectando...', 'bg-warning text-dark');
        };
    }

    function renderQueue(pedidos) {
        const body = document.getElementById('production-queue');
        if (!pedidos || pedidos.length === 0) {
            body.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No hay pedidos pendientes</td></tr>';
            return;
        }
        body.innerHTML = pedidos.map(p => rowTemplate(p)).join('');
    }

    function prependToQueue(pedido) {
        if (document.getElementById(`row-${pedido.id}`)) return;
        const body = document.getElementById('production-queue');
        if (body.innerText.includes('No hay pedidos')) body.innerHTML = '';
        body.insertAdjacentHTML('afterbegin', rowTemplate(pedido));
    }

    function updateOrderRow(pedido) {
        const oldRow = document.getElementById(`row-${pedido.id}`);
        if (oldRow) oldRow.outerHTML = rowTemplate(pedido);
    }

    function removeOrderRow(id) {
        const row = document.getElementById(`row-${id}`);
        if (row) {
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
            row.style.transition = 'all 0.4s ease';
            setTimeout(() => {
                if (row.parentNode) row.remove();
                const body = document.getElementById('production-queue');
                if (body && body.children.length === 0) {
                    renderQueue([]);
                }
            }, 400);
        }
    }

    function rowTemplate(p) {
        const items = p.items.map(i => `${i.cantidad}x ${i.producto}`).join(', ');
        const isPending = p.estado === 'PENDIENTE';
        const badgeClass = isPending ? 'bg-warning-subtle text-warning' : 'bg-success-subtle text-success';
        const btnText = isPending ? 'TERMINAR' : 'FACTURAR';
        const btnAction = isPending ? `window.terminarPedido(${p.id})` : `window.facturarPedido(${p.id})`;
        const btnClass = isPending ? 'btn-primary' : 'btn-success';
        const labelNro = p.numeroFactura ? p.numeroFactura : `#${p.id}`;

        return `
            <tr id="row-${p.id}">
                <td class="ps-4 fw-bold text-primary">${labelNro}</td>
                <td class="small text-muted">${items}</td>
                <td class="text-center fw-bold">$${parseFloat(p.total).toFixed(2)}</td>
                <td class="text-center">
                    <span class="badge ${badgeClass} border px-3 py-2">${p.estado}</span>
                </td>
                <td class="pe-4 text-end">
                    <button id="btn-action-${p.id}" class="btn ${btnClass} btn-sm px-3 fw-bold" onclick="${btnAction}">
                        ${btnText}
                    </button>
                </td>
            </tr>
        `;
    }

    init();
</script>
<style>
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
</style>
{% endblock %}
