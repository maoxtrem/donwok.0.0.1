{% extends 'base.html.twig' %}

{% block title %}Gesti√≥n de Pedidos - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Cola de Producci√≥n</h2>
            <p class="text-muted">Gesti√≥n de estados en tiempo real</p>
        </div>
        <div id="sse-status-badge">
            <span class="badge bg-secondary">Iniciando SSE...</span>
        </div>
    </div>

    <div class="glass-card shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Nro.</th>
                    <th>Productos</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Estado</th>
                    <th class="pe-4 text-end">Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="production-queue">
                <tr><td colspan="5" class="text-center py-5 text-muted">Cargando cola...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Pago -->
<div class="modal fade" id="modalPago" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Finalizar Facturaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <small class="text-muted d-block small fw-bold">VALOR FACTURA</small>
                    <h3 class="fw-extrabold text-primary m-0" id="pago-total-display">$0.00</h3>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-secondary">TRANSFERENCIA (NEQUI/TRANSF.)</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-phone text-info"></i></span>
                        <input type="number" id="input-nequi" class="form-control border-start-0 ps-0 fw-bold" step="0.01" value="0">
                    </div>
                    <small class="text-muted" style="font-size: 0.7rem;">Si es todo en efectivo, dejar en 0.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold text-secondary">EFECTIVO (A REGISTRAR)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-cash-stack text-success"></i></span>
                        <input type="number" id="input-efectivo" class="form-control border-start-0 ps-0 fw-bold bg-light" readonly value="0">
                    </div>
                </div>

                <hr class="my-4 opacity-10">

                <div class="mb-3">
                    <label class="form-label small fw-bold text-primary">EFECTIVO RECIBIDO (CLIENTE)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-person-down text-primary"></i></span>
                        <input type="number" id="input-recibido" class="form-control border-start-0 ps-0 fw-bold" step="0.01" placeholder="¬øCu√°nto entreg√≥?">
                    </div>
                </div>

                <div class="p-3 bg-warning-subtle rounded-3 text-center mb-3 d-none" id="container-cambio">
                    <small class="text-warning-emphasis d-block fw-bold small">CAMBIO A DEVOLVER</small>
                    <h4 class="fw-bold text-dark m-0" id="display-cambio">$0.00</h4>
                </div>

                <div id="pago-error" class="alert alert-danger py-2 small d-none">
                    El valor de transferencia supera el total.
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-primary w-100 py-3 fw-bold shadow" id="btn-confirmar-pago" style="border-radius: 12px;">
                    GENERAR FACTURA
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();
    let selectedPedido = null;
    const modalPagoElement = document.getElementById('modalPago');
    const modalPago = new bootstrap.Modal(modalPagoElement);

    // L√≥gica de c√°lculos del modal
    const inputNequi = document.getElementById('input-nequi');
    const inputEfectivo = document.getElementById('input-efectivo');
    const inputRecibido = document.getElementById('input-recibido');
    const containerCambio = document.getElementById('container-cambio');
    const displayCambio = document.getElementById('display-cambio');
    const errorPago = document.getElementById('pago-error');

    function calcularDistribucion() {
        const row = document.getElementById(`row-${selectedPedido}`);
        if (!row) return;
        const total = parseFloat(row.dataset.total);
        let nequi = parseFloat(inputNequi.value) || 0;

        if (nequi > total) {
            nequi = total;
            inputNequi.value = total.toFixed(2);
            errorPago.classList.remove('d-none');
        } else {
            errorPago.classList.add('d-none');
        }

        const efectivo = total - nequi;
        inputEfectivo.value = efectivo.toFixed(2);
        
        calcularCambio();
    }

    function calcularCambio() {
        const efectivoARegistrar = parseFloat(inputEfectivo.value) || 0;
        const recibido = parseFloat(inputRecibido.value) || 0;

        if (recibido > efectivoARegistrar) {
            const cambio = recibido - efectivoARegistrar;
            displayCambio.innerText = `$${cambio.toFixed(2)}`;
            containerCambio.classList.remove('d-none');
        } else {
            containerCambio.classList.add('d-none');
        }
    }

    inputNequi.addEventListener('input', calcularDistribucion);
    inputRecibido.addEventListener('input', calcularCambio);

    function updateWSStatus(text, colorClass) {
        const container = document.getElementById('sse-status-badge');
        if (container) container.innerHTML = `<span class="badge ${colorClass} animate-pulse">${text}</span>`;
    }

    window.facturarPedido = (id) => {
        const row = document.getElementById(`row-${id}`);
        const total = parseFloat(row.dataset.total);
        selectedPedido = id;

        document.getElementById('pago-total-display').innerText = `$${total.toFixed(2)}`;
        inputNequi.value = "0.00";
        inputRecibido.value = "";
        errorPago.classList.add('d-none');
        containerCambio.classList.add('d-none');
        
        calcularDistribucion();
        modalPago.show();
    };

    document.getElementById('btn-confirmar-pago').addEventListener('click', async () => {
        const efectivo = parseFloat(inputEfectivo.value) || 0;
        const nequi = parseFloat(inputNequi.value) || 0;
        
        const btn = document.getElementById('btn-confirmar-pago');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> PROCESANDO...';

        try {
            await api.post(`/pedidos/${selectedPedido}/facturar`, { efectivo, nequi });
            modalPago.hide();
            removeOrderRow(selectedPedido);
        } catch (err) {
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'GENERAR FACTURA';
        }
    });

    window.terminarPedido = async (id) => {
        const btn = document.getElementById(`btn-action-${id}`);
        if (!btn) return;
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        try {
            const res = await api.post(`/pedidos/${id}/terminar`);
            
            // üü¢ Notificaci√≥n de √âxito
            Swal.fire({
                icon: 'success',
                title: '¬°Pedido Terminado!',
                text: `El pedido #${id} est√° listo para entregar.`,
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });

            if (res.pedido) updateOrderRow(res.pedido);
        } catch (err) { 
            btn.disabled = false;
            btn.innerText = originalText;
            
            // üî¥ Notificaci√≥n de Error
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: err.message || 'No se pudo terminar el pedido.'
            });
        }
    };

    window.eliminarPedido = async (id) => {
        const res = await Swal.fire({
            title: '¬øEliminar este pedido?',
            text: "El pedido se borrar√° permanentemente de la cola.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, eliminar',
            cancelButtonText: 'Cancelar'
        });

        if (res.isConfirmed) {
            try {
                await api.delete(`/pedidos/${id}/eliminar`);
                removeOrderRow(id);
            } catch (err) {
                console.error(err);
            }
        }
    };

    async function init() {
        try {
            const pedidos = await api.get('/pedidos/pendientes');
            renderQueue(pedidos);
            initSSE();
        } catch (err) { 
            console.error("Error inicial:", err);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexi√≥n',
                text: 'No se pudieron cargar los pedidos iniciales.'
            });
        }
    }

    function initSSE() {
        const url = new URL('/.well-known/mercure', window.location.origin);
        url.searchParams.append('topic', 'donwok/pedidos');

        const eventSource = new EventSource(url);

        eventSource.onopen = () => {
            console.log("[SSE] Conectado ‚úÖ");
            updateWSStatus('Tiempo Real: Activo ‚úÖ', 'bg-success');
        };

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("[SSE] Evento:", data);
            
            if (data.type === 'NEW_ORDER') {
                prependToQueue(data.pedido);
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                audio.play().catch(() => {});
            }
            else if (data.type === 'ORDER_READY') updateOrderRow(data.pedido);
            else if (data.type === 'ORDER_INVOICED') removeOrderRow(data.pedido.id);
            else if (data.type === 'ORDER_DELETED') removeOrderRow(data.pedidoId);
        };

        eventSource.onerror = () => {
            updateWSStatus('Reconectando...', 'bg-warning text-dark');
        };
    }

    function renderQueue(pedidos) {
        const body = document.getElementById('production-queue');
        if (!pedidos || pedidos.length === 0) {
            body.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No hay pedidos pendientes</td></tr>';
            return;
        }
        body.innerHTML = pedidos.map(p => rowTemplate(p)).join('');
    }

    function prependToQueue(pedido) {
        if (document.getElementById(`row-${pedido.id}`)) return;
        const body = document.getElementById('production-queue');
        if (body.innerText.includes('No hay pedidos')) body.innerHTML = '';
        body.insertAdjacentHTML('afterbegin', rowTemplate(pedido));
    }

    function updateOrderRow(pedido) {
        const oldRow = document.getElementById(`row-${pedido.id}`);
        if (oldRow) oldRow.outerHTML = rowTemplate(pedido);
    }

    function removeOrderRow(id) {
        const row = document.getElementById(`row-${id}`);
        if (row) {
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
            row.style.transition = 'all 0.4s ease';
            setTimeout(() => {
                if (row.parentNode) row.remove();
                const body = document.getElementById('production-queue');
                if (body && body.children.length === 0) {
                    renderQueue([]);
                }
            }, 400);
        }
    }

    function rowTemplate(p) {
        const items = p.items.map(i => `${i.cantidad}x ${i.producto}`).join(', ');
        const isPending = p.estado === 'PENDIENTE';
        const badgeClass = isPending ? 'bg-warning-subtle text-warning' : 'bg-success-subtle text-success';
        const btnText = isPending ? 'TERMINAR' : 'FACTURAR';
        const btnAction = isPending ? `window.terminarPedido(${p.id})` : `window.facturarPedido(${p.id})`;
        const btnClass = isPending ? 'btn-primary' : 'btn-success';
        const labelNro = p.numeroFactura ? p.numeroFactura : `#${p.id}`;

        return `
            <tr id="row-${p.id}" data-total="${p.total}">
                <td class="ps-4 fw-bold text-primary">${labelNro}</td>
                <td class="small text-muted">${items}</td>
                <td class="text-center fw-bold">$${parseFloat(p.total).toFixed(2)}</td>
                <td class="text-center">
                    <span class="badge ${badgeClass} border px-3 py-2">${p.estado}</span>
                </td>
                <td class="pe-4 text-end">
                    <button id="btn-action-${p.id}" class="btn ${btnClass} btn-sm px-3 fw-bold" onclick="${btnAction}">
                        ${btnText}
                    </button>
                    <button class="btn btn-outline-danger btn-sm px-2" onclick="window.eliminarPedido(${p.id})" title="Eliminar Pedido">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    init();
</script>
<style>
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
</style>
{% endblock %}
