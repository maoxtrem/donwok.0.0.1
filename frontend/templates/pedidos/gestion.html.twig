{% extends 'base.html.twig' %}

{% block title %}Gestión de Pedidos - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Cola de Producción</h2>
            <p class="text-muted">Procesa y factura los pedidos pendientes</p>
        </div>
    </div>

    <div class="glass-card shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Nro.</th>
                    <th>Productos</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Estado</th>
                    <th class="pe-4 text-end">Acción</th>
                </tr>
            </thead>
            <tbody id="production-queue">
                {# Cargado por JS #}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();

    async function init() {
        const pedidos = await api.get('/pedidos/pendientes');
        renderQueue(pedidos);

        // Escuchar tiempo real
        const url = new URL('http://localhost:3001/.well-known/mercure');
        url.searchParams.append('topic', 'donwok/pedidos');
        const eventSource = new EventSource(url);
        
        eventSource.onmessage = e => {
            const data = JSON.parse(e.data);
            if (data.type === 'NEW_ORDER') {
                prependToQueue(data.pedido);
            }
        };
    }

    function renderQueue(pedidos) {
        const body = document.getElementById('production-queue');
        body.innerHTML = pedidos.map(p => rowTemplate(p)).join('');
    }

    function prependToQueue(pedido) {
        const body = document.getElementById('production-queue');
        body.insertAdjacentHTML('afterbegin', rowTemplate(pedido));
    }

    function rowTemplate(p) {
        const items = p.items.map(i => `${i.cantidad}x ${i.producto}`).join(', ');
        return `
            <tr id="row-${p.id}">
                <td class="ps-4 fw-bold">#${p.id}</td>
                <td class="small text-muted">${items}</td>
                <td class="text-center fw-bold">$${parseFloat(p.total).toFixed(2)}</td>
                <td class="text-center">
                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-2">PENDIENTE</span>
                </td>
                <td class="pe-4 text-end">
                    <button class="btn btn-primary btn-sm px-3" onclick="processOrder(${p.id})">
                        FACTURAR
                    </button>
                </td>
            </tr>
        `;
    }

    window.processOrder = async (id) => {
        try {
            await api.post(`/pedidos/${id}/procesar`);
            document.getElementById(`row-${id}`).remove();
        } catch (err) { console.error(err); }
    }

    init();
</script>
{% endblock %}
