{% extends 'base.html.twig' %}

{% block title %}Gestión de Pedidos - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Cola de Producción</h2>
            <p class="text-muted">Gestión de estados en tiempo real</p>
        </div>
        <div id="ws-status-badge">
            <span class="badge bg-secondary">Iniciando WebSocket...</span>
        </div>
    </div>

    <div class="glass-card shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Nro.</th>
                    <th>Productos</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Estado</th>
                    <th class="pe-4 text-end">Acción</th>
                </tr>
            </thead>
            <tbody id="production-queue">
                <tr><td colspan="5" class="text-center py-5 text-muted">Cargando cola...</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();

    // UI Status Helper
    function updateWSStatus(text, colorClass) {
        const container = document.getElementById('ws-status-badge');
        container.innerHTML = `<span class="badge ${colorClass} animate-pulse">${text}</span>`;
    }

    // Funciones globales
    window.terminarPedido = async (id) => {
        const btn = document.getElementById(`btn-action-${id}`);
        if (!btn) return;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const res = await api.post(`/pedidos/${id}/terminar`);
            if (res.pedido) updateOrderRow(res.pedido);
        } catch (err) { 
            btn.disabled = false;
            btn.innerText = 'TERMINAR';
        }
    };

    window.facturarPedido = async (id) => {
        const btn = document.getElementById(`btn-action-${id}`);
        if (!btn) return;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            await api.post(`/pedidos/${id}/facturar`);
            removeOrderRow(id);
        } catch (err) { 
            btn.disabled = false;
            btn.innerText = 'FACTURAR';
        }
    };

    async function init() {
        console.log("%c[Gestión] Iniciando...", "color: blue; font-weight: bold;");
        
        try {
            const pedidos = await api.get('/pedidos/pendientes');
            renderQueue(pedidos);
        } catch (err) { console.error("Error inicial:", err); }

        if (typeof Centrifuge !== 'undefined') {
            const wsUrl = `ws://${window.location.host}/connection/websocket`;
            console.log(`%c[WebSocket] Conectando a ${wsUrl}`, "color: orange;");
            
            const centrifuge = new Centrifuge(wsUrl);
            const sub = centrifuge.newSubscription('public:pedidos');

            // Logs de Eventos
            sub.on('publication', (ctx) => {
                console.log("%c[WebSocket] Mensaje Recibido:", "color: green; font-weight: bold;", ctx.data);
                const data = ctx.data;
                if (data.type === 'NEW_ORDER') prependToQueue(data.pedido);
                else if (data.type === 'ORDER_READY') updateOrderRow(data.pedido);
                else if (data.type === 'ORDER_INVOICED') removeOrderRow(data.pedido.id);
            });

            sub.on('subscribed', () => {
                console.log("%c[WebSocket] Suscrito al canal 'public:pedidos' ✅", "color: green;");
                updateWSStatus('Tiempo Real: Activo ✅', 'bg-success');
            });

            sub.on('error', (err) => {
                console.error("[WebSocket] Error en suscripción:", err);
                updateWSStatus('Error de Suscripción ❌', 'bg-danger');
            });

            centrifuge.on('connected', () => console.log("%c[WebSocket] Conectado al Hub ✅", "color: green;"));
            centrifuge.on('disconnected', () => {
                console.warn("[WebSocket] Desconectado ⚠️");
                updateWSStatus('Reconectando...', 'bg-warning text-dark');
            });

            sub.subscribe();
            centrifuge.connect();
        } else {
            console.error("[Gestión] Error: Centrifuge no cargado.");
        }
    }

    function renderQueue(pedidos) {
        const body = document.getElementById('production-queue');
        if (!pedidos || pedidos.length === 0) {
            body.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No hay pedidos pendientes</td></tr>';
            return;
        }
        body.innerHTML = pedidos.map(p => rowTemplate(p)).join('');
    }

    function prependToQueue(pedido) {
        if (document.getElementById(`row-${pedido.id}`)) return;
        const body = document.getElementById('production-queue');
        if (body.innerText.includes('No hay pedidos')) body.innerHTML = '';
        body.insertAdjacentHTML('afterbegin', rowTemplate(pedido));
    }

    function updateOrderRow(pedido) {
        const oldRow = document.getElementById(`row-${pedido.id}`);
        if (oldRow) oldRow.outerHTML = rowTemplate(pedido);
    }

    function removeOrderRow(id) {
        const row = document.getElementById(`row-${id}`);
        if (row) {
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
            row.style.transition = 'all 0.4s ease';
            setTimeout(() => row.remove(), 400);
        }
    }

    function rowTemplate(p) {
        const items = p.items.map(i => `${i.cantidad}x ${i.producto}`).join(', ');
        const isPending = p.estado === 'PENDIENTE';
        const badgeClass = isPending ? 'bg-warning-subtle text-warning' : 'bg-success-subtle text-success';
        const btnText = isPending ? 'TERMINAR' : 'FACTURAR';
        const btnAction = isPending ? `window.terminarPedido(${p.id})` : `window.facturarPedido(${p.id})`;
        const btnClass = isPending ? 'btn-primary' : 'btn-success';
        const labelNro = p.numeroFactura ? p.numeroFactura : `#${p.id}`;

        return `
            <tr id="row-${p.id}">
                <td class="ps-4 fw-bold text-primary">${labelNro}</td>
                <td class="small text-muted">${items}</td>
                <td class="text-center fw-bold">$${parseFloat(p.total).toFixed(2)}</td>
                <td class="text-center">
                    <span class="badge ${badgeClass} border px-3 py-2">${p.estado}</span>
                </td>
                <td class="pe-4 text-end">
                    <button id="btn-action-${p.id}" class="btn ${btnClass} btn-sm px-3 fw-bold" onclick="${btnAction}">
                        ${btnText}
                    </button>
                </td>
            </tr>
        `;
    }

    init();
</script>
<style>
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
</style>
{% endblock %}
