{% extends 'base.html.twig' %}

{% block title %}Gesti√≥n de Pedidos - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h2 class="fw-bold m-0 text-dark">Cola de Producci√≥n</h2>
            <p class="text-muted mb-0">Gesti√≥n de estados en tiempo real</p>
        </div>
        <div id="sse-status-badge">
            <span class="badge bg-secondary px-3 py-2 rounded-pill">Iniciando SSE...</span>
        </div>
    </div>

    <div class="dw-card shadow-sm overflow-hidden border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-muted fw-bold small text-uppercase">Nro.</th>
                        <th class="py-3 text-muted fw-bold small text-uppercase">Productos</th>
                        <th class="text-center py-3 text-muted fw-bold small text-uppercase">Total</th>
                        <th class="text-center py-3 text-muted fw-bold small text-uppercase">Estado</th>
                        <th class="pe-4 text-end py-3 text-muted fw-bold small text-uppercase">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="production-queue">
                    <tr><td colspan="5" class="text-center py-5 text-muted">Cargando cola...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Pago -->
<div class="modal fade" id="modalPago" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Finalizar Facturaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-5">
                    <small class="text-muted d-block mb-1 fw-bold text-uppercase" style="letter-spacing: 1px;">Total a Cobrar</small>
                    <h1 class="fw-extrabold text-primary m-0 display-4" id="pago-total-display">$0</h1>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-secondary text-uppercase">Transferencia (Nequi / Transf.)</label>
                        <div class="input-group input-group-lg shadow-sm rounded-3 overflow-hidden">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-phone text-info"></i></span>
                            <input type="number" id="input-nequi" class="form-control border-start-0 ps-0 fw-bold" step="0.01" value="0">
                            <button class="btn btn-info text-white fw-bold px-3" type="button" id="btn-nequi-todo">TODO</button>
                        </div>
                        <small class="text-muted mt-2 d-block">Monto pagado por medios digitales.</small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-secondary text-uppercase">Efectivo (A Recibir)</label>
                        <div class="input-group input-group-lg shadow-sm rounded-3 overflow-hidden">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-cash-stack text-success"></i></span>
                            <input type="number" id="input-efectivo" class="form-control border-start-0 ps-0 fw-bold bg-light" readonly value="0">
                            <button class="btn btn-success text-white fw-bold px-3" type="button" id="btn-efectivo-todo">TODO</button>
                        </div>
                        <small class="text-muted mt-2 d-block">Saldo pendiente en efectivo.</small>
                    </div>

                    <div class="col-12" id="wrapper-recibido">
                        <hr class="my-2 opacity-10">
                        <div class="col-md-12">
                            <label class="form-label small fw-bold text-primary text-uppercase">Efectivo Recibido (Cliente)</label>
                            <div class="input-group input-group-lg shadow-sm rounded-3 overflow-hidden mb-3">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-person-down text-primary"></i></span>
                                <input type="number" id="input-recibido" class="form-control border-x-0 ps-0 fw-bold" step="100" placeholder="¬øCu√°nto dinero entreg√≥ el cliente?">
                                <button class="btn btn-outline-danger fw-bold px-3" type="button" id="btn-reset-recibido"><i class="bi bi-x-circle"></i></button>
                            </div>

                            <!-- Botones de Denominaciones R√°pidas (Suman al total) -->
                            <div class="d-flex flex-wrap gap-2 justify-content-center mb-2">
                                {% for monto in [2000, 5000, 10000, 20000, 50000, 100000] %}
                                    <button type="button" class="btn btn-outline-primary btn-sm fw-bold px-3 py-2 rounded-3 quick-cash" data-value="{{ monto }}">
                                        {{ monto|number_format(0, ',', '.') }}
                                    </button>
                                {% endfor %}
                            </div>
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                {% for monto in [50, 100, 200, 500, 1000] %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm fw-bold rounded-pill quick-cash" style="font-size: 0.7rem;" data-value="{{ monto }}">
                                        {{ monto|number_format(0, ',', '.') }}
                                    </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-primary-subtle rounded-4 text-center mt-4 d-none" id="container-cambio" style="border: 2px dashed var(--bs-primary);">
                    <small class="text-primary d-block fw-bold text-uppercase mb-1" style="letter-spacing: 1px;">Cambio a Devolver</small>
                    <h2 class="fw-bold text-dark m-0 display-5" id="display-cambio">$0</h2>
                </div>

                <div id="pago-error" class="alert alert-danger mt-3 py-3 fw-bold small d-none shadow-sm border-0">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> El valor de transferencia supera el total de la factura.
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-primary w-100 py-3 fs-5 fw-bold shadow-lg" id="btn-confirmar-pago" style="border-radius: 15px;">
                    <i class="bi bi-check-circle-fill me-2"></i> CONFIRMAR Y FACTURAR
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();
    let selectedPedido = null;

    // L√≥gica de c√°lculos del modal
    const inputNequi = document.getElementById('input-nequi');
    const inputEfectivo = document.getElementById('input-efectivo');
    const inputRecibido = document.getElementById('input-recibido');
    const containerCambio = document.getElementById('container-cambio');
    const displayCambio = document.getElementById('display-cambio');
    const errorPago = document.getElementById('pago-error');
    const btnNequiTodo = document.getElementById('btn-nequi-todo');
    const btnEfectivoTodo = document.getElementById('btn-efectivo-todo');
    const wrapperRecibido = document.getElementById('wrapper-recibido');

    const fmt = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(v);

    function calcularDistribucion() {
        const row = document.getElementById(`row-${selectedPedido}`);
        if (!row) return;
        const total = parseFloat(row.dataset.total);
        let nequi = parseFloat(inputNequi.value) || 0;

        if (nequi > total) {
            nequi = total;
            inputNequi.value = total;
            errorPago.classList.remove('d-none');
        } else {
            errorPago.classList.add('d-none');
        }

        const efectivo = total - nequi;
        inputEfectivo.value = efectivo;

        // Mostrar/Ocultar secci√≥n de efectivo recibido
        if (efectivo <= 0) {
            wrapperRecibido.classList.add('d-none');
            inputRecibido.value = "";
        } else {
            wrapperRecibido.classList.remove('d-none');
        }
        
        calcularCambio();
    }

    function calcularCambio() {
        const efectivoARegistrar = parseFloat(inputEfectivo.value) || 0;
        const recibido = parseFloat(inputRecibido.value) || 0;

        if (recibido >= efectivoARegistrar && efectivoARegistrar > 0) {
            const cambio = recibido - efectivoARegistrar;
            displayCambio.innerText = fmt(cambio);
            containerCambio.classList.remove('d-none');
        } else {
            containerCambio.classList.add('d-none');
        }
    }

    inputNequi.addEventListener('input', calcularDistribucion);
    inputRecibido.addEventListener('input', calcularCambio);
    
    // Botones de efectivo r√°pido
    const btnResetRecibido = document.getElementById('btn-reset-recibido');
    
    document.querySelectorAll('.quick-cash').forEach(btn => {
        btn.addEventListener('click', () => {
            const valorActual = parseFloat(inputRecibido.value) || 0;
            const valorBoton = parseFloat(btn.dataset.value);
            inputRecibido.value = valorActual + valorBoton;
            calcularCambio();
        });
    });

    btnResetRecibido.addEventListener('click', () => {
        inputRecibido.value = "";
        calcularCambio();
    });

    btnNequiTodo.addEventListener('click', () => {
        const row = document.getElementById(`row-${selectedPedido}`);
        if (row) {
            inputNequi.value = row.dataset.total;
            calcularDistribucion();
        }
    });

    btnEfectivoTodo.addEventListener('click', () => {
        inputNequi.value = 0;
        calcularDistribucion();
    });

    function updateWSStatus(text, colorClass) {
        const container = document.getElementById('sse-status-badge');
        if (container) container.innerHTML = `<span class="badge ${colorClass} animate-pulse">${text}</span>`;
    }

    window.facturarPedido = (id) => {
        const row = document.getElementById(`row-${id}`);
        const total = parseFloat(row.dataset.total);
        selectedPedido = id;

        document.getElementById('pago-total-display').innerText = fmt(total);
        inputNequi.value = 0;
        inputRecibido.value = "";
        errorPago.classList.add('d-none');
        containerCambio.classList.add('d-none');
        
        calcularDistribucion();
        
        const modalEl = document.getElementById('modalPago');
        let modal = bootstrap.Modal.getInstance(modalEl);
        if (!modal) {
            modal = new bootstrap.Modal(modalEl);
        }
        modal.show();
    };

    document.getElementById('btn-confirmar-pago').addEventListener('click', async () => {
        const efectivo = parseFloat(inputEfectivo.value) || 0;
        const nequi = parseFloat(inputNequi.value) || 0;
        const recibido = parseFloat(inputRecibido.value) || 0;
        const cambio = recibido > efectivo ? recibido - efectivo : 0;
        
        const btn = document.getElementById('btn-confirmar-pago');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> PROCESANDO...';

        try {
            await api.post(`/pedidos/${selectedPedido}/facturar`, { efectivo, nequi });
            
            const modalEl = document.getElementById('modalPago');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            if (efectivo > 0 && recibido > efectivo) {
                await Swal.fire({
                    title: '<span class="text-muted small uppercase fw-bold">CAMBIO A ENTREGAR</span>',
                    html: `<h1 class="display-1 fw-bold text-success mt-3">${fmt(cambio)}</h1>`,
                    icon: 'success',
                    confirmButtonText: 'ENTREGADO',
                    confirmButtonColor: '#10b981',
                    allowOutsideClick: true,
                    backdrop: `rgba(0,0,123,0.4)`
                });
            } else {
                Swal.fire({
                    icon: 'success',
                    title: 'Factura Generada',
                    timer: 1500,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }

            removeOrderRow(selectedPedido);
        } catch (err) {
            console.error(err);
            Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo generar la factura.' });
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> CONFIRMAR Y FACTURAR';
        }
    });

    window.terminarPedido = async (id) => {
        const btn = document.getElementById(`btn-action-${id}`);
        if (!btn) return;
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        try {
            const res = await api.post(`/pedidos/${id}/terminar`);
            
            // üü¢ Notificaci√≥n de √âxito
            Swal.fire({
                icon: 'success',
                title: '¬°Pedido Terminado!',
                text: `El pedido #${id} est√° listo para entregar.`,
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });

            if (res.pedido) updateOrderRow(res.pedido);
        } catch (err) { 
            btn.disabled = false;
            btn.innerText = originalText;
            
            // üî¥ Notificaci√≥n de Error
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: err.message || 'No se pudo terminar el pedido.'
            });
        }
    };

    window.eliminarPedido = async (id) => {
        const res = await Swal.fire({
            title: '¬øEliminar este pedido?',
            text: "El pedido se borrar√° permanentemente de la cola.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, eliminar',
            cancelButtonText: 'Cancelar'
        });

        if (res.isConfirmed) {
            try {
                await api.delete(`/pedidos/${id}/eliminar`);
                removeOrderRow(id);
            } catch (err) {
                console.error(err);
            }
        }
    };

    async function init() {
        try {
            const pedidos = await api.get('/pedidos/pendientes');
            renderQueue(pedidos);
            initSSE();
        } catch (err) { 
            console.error("Error inicial:", err);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexi√≥n',
                text: 'No se pudieron cargar los pedidos iniciales.'
            });
        }
    }

    function initSSE() {
        const url = new URL('/.well-known/mercure', window.location.origin);
        url.searchParams.append('topic', 'donwok/pedidos');

        const eventSource = new EventSource(url);

        eventSource.onopen = () => {
            console.log("[SSE] Conectado ‚úÖ");
            updateWSStatus('Tiempo Real: Activo ‚úÖ', 'bg-success');
        };

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("[SSE] Evento:", data);
            
            if (data.type === 'NEW_ORDER') {
                prependToQueue(data.pedido);
                const audio = new Audio('/vendor/notification.mp3');
                audio.play().catch(() => {});
            }
            else if (data.type === 'ORDER_READY') updateOrderRow(data.pedido);
            else if (data.type === 'ORDER_INVOICED') removeOrderRow(data.pedido.id);
            else if (data.type === 'ORDER_DELETED') removeOrderRow(data.pedidoId);
        };

        eventSource.onerror = () => {
            updateWSStatus('Reconectando...', 'bg-warning text-dark');
        };
    }

    function renderQueue(pedidos) {
        const body = document.getElementById('production-queue');
        if (!pedidos || pedidos.length === 0) {
            body.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No hay pedidos pendientes</td></tr>';
            return;
        }
        body.innerHTML = pedidos.map(p => rowTemplate(p)).join('');
    }

    function prependToQueue(pedido) {
        if (document.getElementById(`row-${pedido.id}`)) return;
        const body = document.getElementById('production-queue');
        if (body.innerText.includes('No hay pedidos')) body.innerHTML = '';
        body.insertAdjacentHTML('afterbegin', rowTemplate(pedido));
    }

    function updateOrderRow(pedido) {
        const oldRow = document.getElementById(`row-${pedido.id}`);
        if (oldRow) oldRow.outerHTML = rowTemplate(pedido);
    }

    function removeOrderRow(id) {
        const row = document.getElementById(`row-${id}`);
        if (row) {
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
            row.style.transition = 'all 0.4s ease';
            setTimeout(() => {
                if (row.parentNode) row.remove();
                const body = document.getElementById('production-queue');
                if (body && body.children.length === 0) {
                    renderQueue([]);
                }
            }, 400);
        }
    }

    function rowTemplate(p) {
        const items = p.items.map(i => `${i.cantidad}x ${i.producto}`).join(', ');
        const isPending = p.estado === 'PENDIENTE';
        const badgeClass = isPending ? 'bg-warning-subtle text-warning' : 'bg-success-subtle text-success';
        const btnText = isPending ? 'TERMINAR' : 'FACTURAR';
        const btnAction = isPending ? `window.terminarPedido(${p.id})` : `window.facturarPedido(${p.id})`;
        const btnClass = isPending ? 'btn-primary' : 'btn-success';
        const labelNro = p.numeroTicket ? `T-${p.numeroTicket}` : `#${p.id}`;

        return `
            <tr id="row-${p.id}" data-total="${p.total}">
                <td class="ps-4 fw-bold text-primary">${labelNro}</td>
                <td class="small text-muted">${items}</td>
                <td class="text-center fw-bold">$${parseFloat(p.total).toFixed(2)}</td>
                <td class="text-center">
                    <span class="badge ${badgeClass} border px-3 py-2">${p.estado}</span>
                </td>
                <td class="pe-4 text-end">
                    <button id="btn-action-${p.id}" class="btn ${btnClass} btn-sm px-3 fw-bold" onclick="${btnAction}">
                        ${btnText}
                    </button>
                    <button class="btn btn-outline-danger btn-sm px-2" onclick="window.eliminarPedido(${p.id})" title="Eliminar Pedido">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    init();
</script>
<style>
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
</style>
{% endblock %}
