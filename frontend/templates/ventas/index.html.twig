{% extends 'base.html.twig' %}

{% block title %}Punto de Venta - DonWok{% endblock %}

{% block stylesheets %}
<style>
    /* Layout POS Responsivo */
    .pos-wrapper {
        display: flex;
        flex-direction: row; /* Escritorio: Lado a lado */
        gap: 1.5rem;
        min-height: calc(100vh - 120px);
    }

    @media (max-width: 992px) {
        .pos-wrapper {
            flex-direction: column; /* Tablet/Móvil: Apilados */
            height: auto;
        }
        .invoice-container {
            width: 100% !important; /* Factura ancho completo */
            order: -1; /* Opcional: mostrar factura arriba en móvil para ver total */
            margin-bottom: 2rem;
            position: static !important;
            max-height: none !important;
        }
        .menu-container {
            height: auto;
        }
    }

    /* Panel Izquierdo: Menú */
    .menu-container {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* Buscador Premium */
    .search-bar {
        background: #ffffff;
        border-radius: 12px;
        padding: 0.8rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        border: 1px solid var(--card-border);
        transition: all 0.3s ease;
    }

    .search-bar:focus-within {
        border-color: var(--accent-blue);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
    }

    .search-bar i {
        color: var(--accent-blue);
        font-size: 1.1rem;
    }

    .search-bar input {
        border: none;
        outline: none;
        width: 100%;
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-main);
    }

    .search-bar input::placeholder {
        color: var(--text-muted);
    }

    .products-grid {
        flex: 1;
        padding: 10px 5px 20px 5px;
    }

    /* Ajuste de Cards para que no se encojan */
    .pos-product-card {
        min-width: 200px;
        background: white; 
        border-radius: 16px;
        padding: 0;
        cursor: pointer; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid var(--card-border);
        height: 100%; 
        display: flex; 
        flex-direction: column;
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    .pos-product-card:hover { 
        transform: translateY(-6px); 
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .product-img-wrapper {
        width: 100%;
        height: 160px;
        background-color: #f8fafc;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .product-img-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .pos-product-card:hover .product-img-wrapper img {
        transform: scale(1.05);
    }

    .product-info-wrapper {
        padding: 1.2rem;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .pos-product-card h6 {
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        font-size: 1.05rem;
    }

    .product-description {
        font-size: 0.8rem;
        color: var(--text-muted);
        line-height: 1.2;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .pos-product-card .price-tag {
        color: var(--accent-blue);
        font-weight: 800;
        font-size: 1.2rem;
        margin-top: auto;
    }

    /* Panel Derecho: Factura */
    .invoice-container {
        width: 420px;
        display: flex;
        flex-direction: column;
        position: sticky;
        top: 2rem;
        align-self: flex-start;
        max-height: calc(100vh - 4rem);
    }

    .invoice-card {
        background: white;
        border-radius: 24px;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.04);
        border: 1px solid var(--card-border);
    }

    .invoice-header {
        background: var(--bg-deep);
        color: white;
        padding: 1.5rem;
    }

    .invoice-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .invoice-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--card-border);
    }

    .item-info h6 { margin: 0; font-weight: 700; color: var(--text-main); }
    .item-info small { color: var(--text-muted); }

    .qty-badge {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        padding: 0.2rem 0.8rem;
        border-radius: 20px;
        font-weight: 800;
        font-size: 0.85rem;
    }

    .btn-qty-pos {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: none;
        background: #f7fafc;
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-weight: bold;
    }

    .btn-qty-pos:hover { background: #edf2f7; }

    .invoice-footer {
        padding: 2rem;
        background: #fcfcfc;
        border-top: 1px solid var(--card-border);
    }

    .total-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .total-display .label { font-size: 1.1rem; color: var(--text-muted); font-weight: 600; }
    .total-display .amount { font-size: 2.2rem; font-weight: 800; color: var(--bg-deep); }

    .btn-checkout {
        background: var(--accent-blue);
        color: white;
        border: none;
        width: 100%;
        padding: 1.2rem;
        border-radius: 16px;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
        transition: all 0.3s;
    }

    .btn-checkout:hover:not(:disabled) {
        background: var(--accent-hover);
        transform: translateY(-2px);
        box-shadow: 0 12px 25px rgba(59, 130, 246, 0.3);
    }

    .btn-checkout:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid p-4">
    <div class="pos-wrapper">
        
        <!-- PANEL IZQUIERDO: MENÚ -->
        <div class="menu-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark m-0">Punto de Venta</h2>
                    <div class="d-flex gap-2 mt-2">
                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1" style="font-size: 0.75rem;">
                            <i class="bi bi-hourglass-split"></i> EN COLA: <b id="count-cola">0</b>
                        </span>
                        <span class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1" style="font-size: 0.75rem;">
                            <i class="bi bi-check-circle"></i> LISTOS: <b id="count-listos">0</b>
                        </span>
                    </div>
                </div>
                <div class="text-muted small"><i class="bi bi-clock me-1"></i> <span id="current-time"></span></div>
            </div>

            <div class="search-bar">
                <i class="bi bi-search text-muted"></i>
                <input type="text" id="productSearch" placeholder="Buscar producto por nombre..." onkeyup="filterProducts()">
            </div>

            <div class="products-grid">
                <div class="row" id="menu-items">
                    <!-- Cargado por JS -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL DERECHO: FACTURA -->
        <div class="invoice-container">
            <div class="invoice-card shadow-sm">
                <div class="invoice-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 fw-bold">Pedido Actual</h5>
                            <small class="opacity-75">DonWok Principal</small>
                        </div>
                        <i class="bi bi-receipt h4 mb-0 opacity-50"></i>
                    </div>
                </div>

                <div class="invoice-body" id="invoice-items-list">
                    <div class="text-center text-muted mt-5 py-5">
                        <i class="bi bi-cart-x h1 d-block mb-3 opacity-20"></i>
                        <p>No hay productos en el pedido</p>
                    </div>
                </div>

                <div class="invoice-footer">
                    <div class="total-display">
                        <span class="label">Total a Pagar</span>
                        <span class="amount" id="grand-total">$0.00</span>
                    </div>
                    <button class="btn-checkout" id="btn-process" disabled onclick="processOrder()">
                        PROCESAR PEDIDO
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();
    
    let allProducts = [];
    let cart = [];

    // Reloj
    setInterval(() => {
        const now = new Date();
        document.getElementById('current-time').innerText = now.toLocaleTimeString();
    }, 1000);

    // Cargar productos y estadísticas
    async function init() {
        try {
            const [productsData, stats] = await Promise.all([
                api.get('/productos'),
                api.get('/pedidos/stats')
            ]);

            allProducts = productsData.filter(p => p.activo);
            renderMenu(allProducts);
            updateStats(stats);
            initSSE();
        } catch (err) {
            document.getElementById('menu-items').innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    }

    function updateStats(stats) {
        if (stats.pendientes !== undefined) document.getElementById('count-cola').innerText = stats.pendientes;
        if (stats.terminados !== undefined) document.getElementById('count-listos').innerText = stats.terminados;
    }

    function initSSE() {
        const url = new URL('/.well-known/mercure', window.location.origin);
        url.searchParams.append('topic', 'donwok/pedidos');
        const eventSource = new EventSource(url);
        
        eventSource.onmessage = async () => {
            // Recargamos stats en cada evento relevante para asegurar precisión
            const stats = await api.get('/pedidos/stats');
            updateStats(stats);
        };
    }

    function renderMenu(products) {
        const grid = document.getElementById('menu-items');
        if (products.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center py-5 text-muted">No se encontraron productos</div>';
            return;
        }

        const defaultImg = '/vendor/placeholder-food.jpg';

        grid.innerHTML = products.map(p => `
            <div class="col-sm-6 mb-2">
                <div class="pos-product-card" onclick='window.addToCart(${JSON.stringify(p)})'>
                    <div class="product-img-wrapper">
                        <img src="${defaultImg}" alt="${p.nombre}">
                    </div>
                    <div class="product-info-wrapper">
                        <h6>${p.nombre}</h6>
                        <p class="product-description">Sabor original DonWok, preparado con ingredientes frescos del día.</p>
                        <span class="price-tag">$${parseFloat(p.precioActual).toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Exponer funciones globales
    window.filterProducts = () => {
        const query = document.getElementById('productSearch').value.toLowerCase();
        const filtered = allProducts.filter(p => p.nombre.toLowerCase().includes(query));
        renderMenu(filtered);
    };

    window.addToCart = (product) => {
        const existing = cart.find(item => item.id === product.id);
        if (existing) {
            existing.qty++;
        } else {
            cart.push({ ...product, qty: 1 });
        }
        renderInvoice();
    };

    window.updateQty = (id, delta) => {
        const item = cart.find(i => i.id === id);
        if (!item) return;
        item.qty += delta;
        if (item.qty <= 0) {
            cart = cart.filter(i => i.id !== id);
        }
        renderInvoice();
    };

    function renderInvoice() {
        const list = document.getElementById('invoice-items-list');
        const totalAmount = document.getElementById('grand-total');
        const btn = document.getElementById('btn-process');

        if (cart.length === 0) {
            list.innerHTML = '<div class="text-center text-muted mt-5 py-5"><i class="bi bi-cart-x h1 d-block mb-3 opacity-20"></i><p>No hay productos en el pedido</p></div>';
            totalAmount.innerText = '$0.00';
            btn.disabled = true;
            return;
        }

        let total = 0;
        list.innerHTML = cart.map(item => {
            const subtotal = item.precioActual * item.qty;
            total += subtotal;
            return `
                <div class="invoice-item">
                    <div class="item-info">
                        <h6>${item.nombre}</h6>
                        <small>$${parseFloat(item.precioActual).toFixed(2)} x ${item.qty}</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn-qty-pos" onclick="window.updateQty(${item.id}, -1)">-</button>
                        <span class="qty-badge">${item.qty}</span>
                        <button class="btn-qty-pos" onclick="window.updateQty(${item.id}, 1)">+</button>
                        <div class="ms-3 fw-bold text-dark" style="min-width: 70px; text-align: right;">$${subtotal.toFixed(2)}</div>
                    </div>
                </div>
            `;
        }).join('');

        totalAmount.innerText = `$${total.toFixed(2)}`;
        btn.disabled = false;
    }

    window.processOrder = async () => {
        if (cart.length === 0) return;
        const btn = document.getElementById('btn-process');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'PROCESANDO...';

        try {
            const payload = {
                items: cart.map(item => ({
                    id: item.id,
                    qty: item.qty
                }))
            };

            const response = await api.post('/pedidos', payload);
            
            // Mostrar modal con el número de tiquete
            if (response.pedido && response.pedido.numeroTicket) {
                await Swal.fire({
                    title: '<span class="text-muted small uppercase fw-bold">TIQUETE DE PEDIDO</span>',
                    html: `
                        <div class="py-4">
                            <h1 class="display-1 fw-black text-primary mb-0" style="font-size: 8rem;">${response.pedido.numeroTicket}</h1>
                            <p class="text-muted mt-2">ID de Factura: #${response.pedido.id}</p>
                        </div>
                    `,
                    icon: 'success',
                    confirmButtonText: 'ENTENDIDO',
                    confirmButtonColor: '#3b82f6',
                    allowOutsideClick: false,
                    backdrop: `rgba(15, 23, 42, 0.9)`
                });
            }
            
            cart = [];
            renderInvoice();
        } catch (err) {
            // api.notify ya maneja la notificación de error
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    };

    // Iniciar
    init();

</script>
{% endblock %}