{% extends 'base.html.twig' %}

{% block body_class %}login-page{% endblock %}
{# Forzamos ocultar sidebar en login si no hay sesión #}
{% block show_sidebar %}{% endblock %}

{% block body %}
<div class="d-flex justify-content-center align-items-center vh-100" style="background: var(--bg-deep);">
    <div class="dw-card p-5 shadow-lg border-0" style="width: 100%; max-width: 420px;">
        <div class="text-center mb-5">
            <div class="bg-primary d-inline-block p-3 rounded-4 text-white shadow-sm mb-3">
                <i class="bi bi-shop-window h2 mb-0"></i>
            </div>
            <h2 class="fw-bold text-dark mb-1" style="letter-spacing: -1px;">DonWok Control</h2>
            <p class="text-muted small fw-bold text-uppercase" style="letter-spacing: 1px;">Gestión de Negocio</p>
        </div>

        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Usuario</label>
                <input type="text" id="username" class="form-control border-0 bg-light py-3 px-4 fw-bold" placeholder="admin" required autofocus style="border-radius: 12px;">
            </div>
            <div class="mb-5">
                <label class="form-label small fw-bold text-muted text-uppercase">Contraseña</label>
                <input type="password" id="password" class="form-control border-0 bg-light py-3 px-4 fw-bold" placeholder="••••••••" required style="border-radius: 12px;">
            </div>

            <button type="submit" id="btnLogin" class="dw-btn-primary text-white w-100 py-3 shadow-lg">
                <span id="btnText">ACCEDER AL SISTEMA</span>
                <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
        </form>
        
        <div class="text-center mt-5">
            <small class="text-muted opacity-50">© 2026 DonWok POS System</small>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
import CoreAPI from '/js/core.js';
const api = new CoreAPI();

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const btn = document.getElementById('btnLogin');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');

    btn.disabled = true;
    btnText.classList.add('d-none');
    btnSpinner.classList.remove('d-none');

    try {
        // 1. Obtener Token JWT (Solo para handshake)
        const token = await api.loginAuth(username, password);
        
        // 2. Establecer Sesión en Core (Aquí se crea la cookie CORESESSID)
        await api.establishSession(token);

        // 3. Redirigir (La cookie ya está en el navegador)
        window.location.href = '/dashboard';
    } catch (err) {
        // La clase CoreAPI ya dispara la notificación de SweetAlert2
        btn.disabled = false;
        btnText.classList.remove('d-none');
        btnSpinner.classList.add('d-none');
    }
});
</script>
{% endblock %}
