{% extends 'base.html.twig' %}

{% block title %}Inventario - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-dark">Inventario de Productos</h2>
            <p class="text-muted">Gestiona el catálogo de productos desde el Core Service</p>
        </div>
        <button class="btn btn-primary d-flex align-items-center gap-2 px-4 py-2 shadow-sm" 
                style="border-radius: 10px;" onclick="openModal()">
            <i class="bi bi-plus-lg"></i> Nuevo Producto
        </button>
    </div>

    <div class="glass-card shadow-sm overflow-hidden">
        <table class="table table-hover mb-0 align-middle">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4 py-3 text-secondary small text-uppercase">Producto</th>
                    <th class="py-3 text-secondary small text-uppercase text-center">Costo</th>
                    <th class="py-3 text-secondary small text-uppercase text-center">Precio Venta</th>
                    <th class="py-3 text-secondary small text-uppercase text-center">Estado</th>
                    <th class="pe-4 py-3 text-secondary small text-uppercase text-end">Acciones</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                {# Cargado por JS #}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div class="mt-2 text-muted">Cargando inventario...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{# Modal de Producto #}
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitle">Nuevo Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="productForm">
                <div class="modal-body p-4">
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre</label>
                        <input type="text" id="pNombre" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold">Costo</label>
                            <input type="number" step="0.01" id="pCosto" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold">Precio Venta</label>
                            <input type="number" step="0.01" id="pPrecio" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="pActivo" checked>
                        <label class="form-check-label fw-bold">Producto Activo</label>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 p-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4 shadow-sm" style="border-radius: 10px;">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();
    let productModal;

    document.addEventListener('DOMContentLoaded', () => {
        productModal = new bootstrap.Modal(document.getElementById('productModal'));
        loadProducts();
    });

    window.loadProducts = async () => {
        try {
            const data = await api.get('/productos');
            renderTable(data);
        } catch (err) {
            document.getElementById('productsTableBody').innerHTML = `
                <tr><td colspan="5" class="text-center py-5 text-danger">${err.message}</td></tr>
            `;
        }
    };

    window.renderTable = (products) => {
        const body = document.getElementById('productsTableBody');
        body.innerHTML = products.map(p => `
            <tr>
                <td class="ps-4">
                    <div class="fw-bold text-dark">${p.nombre}</div>
                    <small class="text-muted">ID: #${p.id}</small>
                </td>
                <td class="text-center text-muted">$${parseFloat(p.costoActual).toFixed(2)}</td>
                <td class="text-center fw-bold text-primary">$${parseFloat(p.precioActual).toFixed(2)}</td>
                <td class="text-center">
                    <span class="badge ${p.activo ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'} border px-3 py-2">
                        ${p.activo ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td class="pe-4 text-end">
                    <div class="btn-group shadow-sm">
                        <button class="btn btn-white btn-sm border" onclick="editProduct(${p.id}, '${p.nombre}', ${p.precioActual}, ${p.costoActual}, ${p.activo})"><i class="bi bi-pencil text-primary"></i></button>
                        <button class="btn btn-white btn-sm border" onclick="deleteProduct(${p.id})"><i class="bi bi-trash text-danger"></i></button>
                    </div>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="5" class="text-center py-5">No hay productos.</td></tr>';
    };

    window.openModal = () => {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('modalTitle').innerText = 'Nuevo Producto';
        productModal.show();
    };

    window.editProduct = (id, nombre, precio, costo, activo) => {
        document.getElementById('productId').value = id;
        document.getElementById('pNombre').value = nombre;
        document.getElementById('pPrecio').value = precio;
        document.getElementById('pCosto').value = costo;
        document.getElementById('pActivo').checked = activo;
        document.getElementById('modalTitle').innerText = 'Editar Producto';
        productModal.show();
    };

    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('productId').value;
        const payload = {
            nombre: document.getElementById('pNombre').value,
            precioActual: parseFloat(document.getElementById('pPrecio').value),
            costoActual: parseFloat(document.getElementById('pCosto').value),
            activo: document.getElementById('pActivo').checked
        };

        try {
            if (id) {
                await api.put(`/productos/${id}`, payload);
            } else {
                await api.post('/productos', payload);
            }
            productModal.hide();
            loadProducts();
        } catch (err) { /* Notificado por CoreAPI */ }
    });

    window.deleteProduct = async (id) => {
        if (!confirm('¿Eliminar producto?')) return;
        try {
            await api.delete(`/productos/${id}`);
            loadProducts();
        } catch (err) { /* Notificado por CoreAPI */ }
    };
</script>
{% endblock %}