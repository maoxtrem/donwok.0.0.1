{% extends 'base.html.twig' %}

{% block title %}Analítica Detallada - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h2 class="fw-bold m-0 text-dark">Informes y Analítica</h2>
            <p class="text-muted mb-0">Fuente de Verdad: Movimientos Financieros</p>
        </div>
        
        <!-- Filtro Global de Fechas para KPIs -->
        <div class="dw-card p-2 d-flex gap-2 align-items-center border-0">
            <span class="text-muted small fw-bold ps-2">FILTRAR:</span>
            <input type="date" id="filtro-desde" class="form-control form-control-sm border-0 bg-transparent fw-bold" style="width: 130px;">
            <span class="text-muted small fw-bold">AL</span>
            <input type="date" id="filtro-hasta" class="form-control form-control-sm border-0 bg-transparent fw-bold" style="width: 130px;">
            <button class="dw-btn-primary text-white btn-sm px-3 shadow-sm" onclick="cargarKPIs()">
                <i class="bi bi-filter"></i>
            </button>
        </div>
    </div>

    <!-- 1. BLOQUE DE KPIs (6 Tarjetas) -->
    <div class="row g-3 mb-5">
        <div class="col-6 col-xl-2">
            <div class="dw-card p-3 border-0 shadow-sm h-100 border-start border-4 border-success text-center">
                <small class="text-muted fw-bold d-block mb-1">VENTAS</small>
                <h5 class="fw-bold m-0 text-success" id="kpi-total-ventas">$0</h5>
            </div>
        </div>
        <div class="col-6 col-xl-2">
            <div class="dw-card p-3 border-0 shadow-sm h-100 border-start border-4 border-danger text-center">
                <small class="text-muted fw-bold d-block mb-1">GASTOS</small>
                <h5 class="fw-bold m-0 text-danger" id="kpi-total-gastos">$0</h5>
            </div>
        </div>
        <div class="col-6 col-xl-2">
            <div class="dw-card p-3 border-0 shadow-sm h-100 border-start border-4 border-primary text-center">
                <small class="text-muted fw-bold d-block mb-1">UTILIDAD</small>
                <h5 class="fw-bold m-0 text-primary" id="kpi-utilidad-total">$0</h5>
            </div>
        </div>
        <div class="col-6 col-xl-2">
            <div class="dw-card p-3 border-0 shadow-sm h-100 border-start border-4 border-info text-center">
                <small class="text-muted fw-bold d-block mb-1">AVG. VENTA</small>
                <h5 class="fw-bold m-0 text-info" id="kpi-avg-venta">$0</h5>
            </div>
        </div>
        <div class="col-6 col-xl-2">
            <div class="dw-card p-3 border-0 shadow-sm h-100 border-start border-4 border-warning text-center">
                <small class="text-muted fw-bold d-block mb-1">AVG. GASTO</small>
                <h5 class="fw-bold m-0 text-warning-emphasis" id="kpi-avg-gasto">$0</h5>
            </div>
        </div>
        <div class="col-6 col-xl-2">
            <div class="dw-card p-3 border-0 shadow-sm h-100 border-start border-4 border-dark text-center">
                <small class="text-muted fw-bold d-block mb-1">AVG. UTILIDAD</small>
                <h5 class="fw-bold m-0 text-dark" id="kpi-avg-utilidad">$0</h5>
            </div>
        </div>
    </div>

    <!-- 2. GRÁFICA MENSUAL (DÍA A DÍA) -->
    <div class="row g-4 mb-5">
        <div class="col-12">
            <div class="dw-card p-4 shadow-sm border-0">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
                    <div>
                        <h6 class="fw-bold m-0 text-dark small text-uppercase" style="letter-spacing: 0.5px;">Tendencia Diaria (Mes Actual)</h6>
                        <small class="text-muted">Ventas, Gastos y Utilidad por día</small>
                    </div>
                    <div class="d-flex gap-2">
                        <select id="mes-diario" class="form-select form-select-sm" onchange="cargarGraficasMensuales()"></select>
                        <select id="anio-diario" class="form-select form-select-sm" onchange="cargarGraficasMensuales()"></select>
                    </div>
                </div>
                <div style="height: 350px;">
                    <canvas id="chart-diario"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <!-- 3. GRÁFICA SEMANAL -->
        <div class="col-lg-6">
            <div class="dw-card p-4 shadow-sm border-0 h-100">
                <h6 class="fw-bold mb-4 text-dark small text-uppercase" style="letter-spacing: 0.5px;">Comparativa por Semanas</h6>
                <div style="height: 350px;">
                    <canvas id="chart-semanal"></canvas>
                </div>
            </div>
        </div>

        <!-- 4. DETALLE SEMANAL (GRÁFICA DE BARRAS) -->
        <div class="col-lg-6">
            <div class="dw-card p-4 shadow-sm border-0 h-100">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
                    <h6 class="m-0 fw-bold text-dark small text-uppercase" style="letter-spacing: 0.5px;">Detalle Diario de la Semana</h6>
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-sm btn-white border shadow-sm" onclick="window.cambiarSemanaDetalle(-7)"><i class="bi bi-chevron-left"></i></button>
                        <span id="label-semana" class="small fw-bold text-primary" style="min-width: 160px; text-align: center;"></span>
                        <button class="btn btn-sm btn-white border shadow-sm" onclick="window.cambiarSemanaDetalle(7)"><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
                <div style="height: 350px;">
                    <canvas id="chart-detalle-semanal"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="/vendor/chart.js/chart.umd.js"></script>
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();

    let chartDiario = null;
    let chartSemanal = null;
    let chartDetalleSemanal = null;
    let currentWeekStart = getMonday(new Date());

    const fmt = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(v);

    function init() {
        const hoy = new Date();
        const hace30 = new Date();
        hace30.setDate(hoy.getDate() - 30);

        document.getElementById('filtro-desde').value = hace30.toISOString().split('T')[0];
        document.getElementById('filtro-hasta').value = hoy.toISOString().split('T')[0];

        // Llenar selectores de mes/año
        const mesSelect = document.getElementById('mes-diario');
        const anioSelect = document.getElementById('anio-diario');
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        meses.forEach((m, i) => {
            const opt = new Option(m, i + 1);
            if (i === hoy.getMonth()) opt.selected = true;
            mesSelect.add(opt);
        });

        [2025, 2026].forEach(y => {
            const opt = new Option(y, y);
            if (y === hoy.getFullYear()) opt.selected = true;
            anioSelect.add(opt);
        });

        cargarKPIs();
        cargarGraficasMensuales();
        cargarDetalleSemanal();
    }

    async function cargarKPIs() {
        const desde = document.getElementById('filtro-desde').value;
        const hasta = document.getElementById('filtro-hasta').value;
        try {
            const data = await api.get(`/informes/resumen-general?desde=${desde}&hasta=${hasta}`);
            const k = data.kpis;
            document.getElementById('kpi-total-ventas').innerText = fmt(k.total_ventas);
            document.getElementById('kpi-total-gastos').innerText = fmt(k.total_gastos);
            document.getElementById('kpi-utilidad-total').innerText = fmt(k.utilidad_total);
            document.getElementById('kpi-avg-venta').innerText = fmt(k.promedio_venta_dia);
            document.getElementById('kpi-avg-gasto').innerText = fmt(k.promedio_gasto_dia);
            document.getElementById('kpi-avg-utilidad').innerText = fmt(k.promedio_utilidad_dia);
        } catch (err) { console.error(err); }
    }

    async function cargarGraficasMensuales() {
        const mes = document.getElementById('mes-diario').value;
        const anio = document.getElementById('anio-diario').value;
        try {
            const data = await api.get(`/informes/analitica-mensual-detallada?mes=${mes}&anio=${anio}`);
            renderChartDiario(data.diario);
            renderChartSemanal(data.semanal);
        } catch (err) { console.error(err); }
    }

    async function cargarDetalleSemanal() {
        const desde = currentWeekStart.toISOString().split('T')[0];
        const hasta = new Date(currentWeekStart);
        hasta.setDate(hasta.getDate() + 6);
        
        document.getElementById('label-semana').innerText = `${desde} al ${hasta.toISOString().split('T')[0]}`;

        try {
            const data = await api.get(`/informes/detalle-semanal?desde=${desde}`);
            renderChartDetalleSemanal(data);
        } catch (err) { console.error(err); }
    }

    function renderChartDiario(diario) {
        const ctx = document.getElementById('chart-diario').getContext('2d');
        const labels = Object.keys(diario).map(f => f.split('-')[2]); // Solo el día
        const datasetVentas = Object.values(diario).map(d => d.ventas);
        const datasetGastos = Object.values(diario).map(d => d.gastos);
        const datasetUtilidad = Object.values(diario).map(d => d.utilidad);

        if (chartDiario) chartDiario.destroy();

        chartDiario = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Ventas', data: datasetVentas, borderColor: '#10b981', backgroundColor: '#10b981', tension: 0.4, borderWidth: 3, pointRadius: 4, pointHoverRadius: 6 },
                    { label: 'Gastos', data: datasetGastos, borderColor: '#ef4444', backgroundColor: '#ef4444', tension: 0.4, borderWidth: 3, pointRadius: 4, pointHoverRadius: 6 },
                    { label: 'Utilidad', data: datasetUtilidad, borderColor: '#3b82f6', backgroundColor: '#3b82f6', tension: 0.4, borderWidth: 3, borderDash: [5, 5], pointRadius: 4, pointHoverRadius: 6 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { 
                    y: { beginAtZero: true, ticks: { callback: v => fmt(v) } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderChartSemanal(semanal) {
        const ctx = document.getElementById('chart-semanal').getContext('2d');
        const labels = Object.keys(semanal);
        const datasetVentas = labels.map(l => semanal[l].ventas);
        const datasetGastos = labels.map(l => semanal[l].gastos);
        const datasetUtilidad = labels.map(l => semanal[l].utilidad);

        if (chartSemanal) chartSemanal.destroy();

        chartSemanal = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Ventas', data: datasetVentas, backgroundColor: '#10b981', borderRadius: 5 },
                    { label: 'Gastos', data: datasetGastos, backgroundColor: '#ef4444', borderRadius: 5 },
                    { label: 'Utilidad', data: datasetUtilidad, backgroundColor: '#3b82f6', borderRadius: 5 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { 
                    y: { beginAtZero: true, ticks: { callback: v => fmt(v) } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderChartDetalleSemanal(data) {
        const ctx = document.getElementById('chart-detalle-semanal').getContext('2d');
        const labels = data.map(d => d.dia);
        const ventas = data.map(d => d.ventas);
        const gastos = data.map(d => d.gastos);
        const utilidad = data.map(d => d.utilidad);

        if (chartDetalleSemanal) chartDetalleSemanal.destroy();

        chartDetalleSemanal = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Ventas', data: ventas, backgroundColor: '#10b981', borderRadius: 4 },
                    { label: 'Gastos', data: gastos, backgroundColor: '#ef4444', borderRadius: 4 },
                    { label: 'Utilidad', data: utilidad, backgroundColor: '#3b82f6', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + fmt(context.raw);
                            }
                        }
                    }
                },
                scales: { 
                    y: { beginAtZero: true, ticks: { callback: v => fmt(v) } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function getMonday(d) {
        d = new Date(d);
        const day = d.getDay(),
            diff = d.getDate() - day + (day == 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }

    window.cambiarSemanaDetalle = (delta) => {
        currentWeekStart.setDate(currentWeekStart.getDate() + delta);
        cargarDetalleSemanal();
    };

    window.cargarKPIs = cargarKPIs;
    window.cargarGraficasMensuales = cargarGraficasMensuales;

    init();
</script>
{% endblock %}