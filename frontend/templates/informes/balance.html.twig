{% extends 'base.html.twig' %}

{% block title %}Balance General - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h2 class="fw-bold m-0 text-dark">Balance General</h2>
            <p class="text-muted mb-0">Estado integral de liquidez, rentabilidad y patrimonio</p>
        </div>
        <div class="dw-card p-2 d-flex gap-2 align-items-center border-0">
            <input type="date" id="balance-desde" class="form-control form-control-sm border-0 bg-transparent fw-bold" style="width: 130px;">
            <span class="text-muted small fw-bold">AL</span>
            <input type="date" id="balance-hasta" class="form-control form-control-sm border-0 bg-transparent fw-bold" style="width: 130px;">
            <button class="dw-btn-primary text-white btn-sm px-3 shadow-sm" onclick="cargarBalance()">
                <i class="bi bi-arrow-repeat"></i>
            </button>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- ðŸ’° LIQUIDEZ ACTUAL -->
        <div class="col-lg-4">
            <div class="dw-card h-100 shadow-sm overflow-hidden border-0">
                <div class="p-3 bg-primary text-white">
                    <h6 class="m-0 fw-bold small text-uppercase" style="letter-spacing: 0.5px;"><i class="bi bi-wallet2 me-2"></i> Liquidez Disponible</h6>
                </div>
                <div class="p-4">
                    <div id="lista-cuentas"></div>
                    <hr class="my-3 opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-muted small">TOTAL EFECTIVO</span>
                        <span class="h4 fw-bold text-primary m-0" id="total-liquidez">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ðŸ“‰ CARTERA (CUENTAS POR COBRAR) -->
        <div class="col-lg-4">
            <div class="dw-card h-100 shadow-sm overflow-hidden border-0">
                <div class="p-3 bg-info text-white">
                    <h6 class="m-0 fw-bold small text-uppercase" style="letter-spacing: 0.5px;"><i class="bi bi-person-badge me-2"></i> Cartera Pendiente</h6>
                </div>
                <div class="p-0">
                    <div class="table-responsive" style="max-height: 180px;">
                        <table class="table table-hover align-middle mb-0 small">
                            <tbody id="lista-cartera"></tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-muted small">TOTAL POR COBRAR</span>
                        <span class="h5 fw-bold text-info m-0" id="total-cartera">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ðŸŽ¯ GANANCIA NETA DEL PERIODO -->
        <div class="col-lg-4">
            <div class="dw-card h-100 shadow-sm overflow-hidden border-start border-5 border-warning border-0">
                <div class="p-4 text-center d-flex flex-column justify-content-center h-100">
                    <small class="text-muted fw-bold d-block mb-2 text-uppercase" style="letter-spacing: 0.5px;">Ganancia Neta Periodo</small>
                    <h1 class="fw-bold text-dark mb-2" id="kpi-ganancia-neta" style="font-size: 2.5rem; letter-spacing: -1px;">$0.00</h1>
                    <div id="ganancia-status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ðŸ¦ RESUMEN PATRIMONIAL -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="dw-card p-4 shadow-sm bg-deep text-white border-0" style="background: var(--bg-deep) !important;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="fw-bold mb-1" style="letter-spacing: -0.5px;">VALOR REAL DEL NEGOCIO (Patrimonio Neto)</h4>
                        <p class="text-white-50 small mb-0">Calculado como: (Liquidez + Cartera) - Deudas Pendientes</p>
                    </div>
                    <div class="col-md-4 text-center text-md-end">
                        <h1 class="fw-bold m-0 text-warning" id="patrimonio-neto" style="font-size: clamp(1.8rem, 5vw, 3rem); letter-spacing: -1.5px;">$0.00</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ðŸ“Š DESGLOSE DETALLADO -->
    <div class="row g-4">
        <!-- INGRESOS -->
        <div class="col-lg-4">
            <div class="dw-card shadow-sm overflow-hidden border-0">
                <div class="p-3 bg-success-subtle border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-success-emphasis small text-uppercase">INGRESOS</h6>
                    <span class="fw-bold text-success" id="subtotal-ingresos">$0.00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <tbody id="table-ingresos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- EGRESOS -->
        <div class="col-lg-4">
            <div class="dw-card shadow-sm overflow-hidden border-0">
                <div class="p-3 bg-danger-subtle border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-danger-emphasis small text-uppercase">EGRESOS</h6>
                    <span class="fw-bold text-danger" id="subtotal-egresos">$0.00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <tbody id="table-egresos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PASIVOS (DEUDAS) -->
        <div class="col-lg-4">
            <div class="dw-card shadow-sm overflow-hidden h-100 border-0">
                <div class="p-3 bg-warning-subtle border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-warning-emphasis small text-uppercase">PASIVOS (DEUDAS)</h6>
                    <span class="fw-bold text-warning-emphasis" id="total-pasivos">$0.00</span>
                </div>
                <div class="table-responsive" style="max-height: 250px;">
                    <table class="table table-hover mb-0 small">
                        <tbody id="table-pasivos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RENTABILIDAD POR PRODUCTO -->
        <div class="col-12 mb-5">
            <div class="dw-card shadow-sm overflow-hidden border-0">
                <div class="p-3 bg-deep text-white d-flex justify-content-between align-items-center" style="background: var(--bg-deep) !important;">
                    <h6 class="m-0 fw-bold small text-uppercase" style="letter-spacing: 0.5px;">Rentabilidad por Producto</h6>
                    <span class="badge bg-warning text-dark px-3 py-2 fw-bold" id="utilidad-bruta-total">Utilidad Bruta: $0.00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light small">
                            <tr>
                                <th class="ps-4 py-3 fw-bold text-muted">Producto</th>
                                <th class="text-center py-3 fw-bold text-muted">Cant.</th>
                                <th class="text-end py-3 fw-bold text-muted">Ventas</th>
                                <th class="text-end py-3 fw-bold text-muted">Costos</th>
                                <th class="text-end pe-4 py-3 fw-bold text-muted">Ganancia</th>
                            </tr>
                        </thead>
                        <tbody id="table-rentabilidad"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();

    // Inicializar fechas (mes actual)
    const hoy = new Date();
    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    document.getElementById('balance-desde').value = inicioMes.toISOString().split('T')[0];
    document.getElementById('balance-hasta').value = hoy.toISOString().split('T')[0];

    const fmt = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(v);

    async function cargarBalance() {
        const desde = document.getElementById('balance-desde').value;
        const hasta = document.getElementById('balance-hasta').value;
        const params = `?desde=${desde}&hasta=${hasta}`;

        try {
            const data = await api.get(`/informes/balance-completo${params}`);
            const rent = await api.get(`/informes/rentabilidad-productos${params}`);
            
            renderLiquidez(data.liquidez);
            renderCartera(data.cartera);
            renderPasivos(data.pasivos);
            renderPatrimonio(data.patrimonio.neto);
            renderResultados(data.resultados);
            renderRentabilidad(rent, data.resultados.utilidad_bruta);
        } catch (err) { console.error(err); }
    }

    function renderLiquidez(liquidez) {
        const container = document.getElementById('lista-cuentas');
        container.innerHTML = liquidez.cuentas.map(c => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted small fw-bold">${c.nombre}</span>
                <span class="fw-bold">${fmt(c.saldo)}</span>
            </div>
        `).join('');
        document.getElementById('total-liquidez').innerText = fmt(liquidez.total_efectivo);
    }

    function renderCartera(cartera) {
        const body = document.getElementById('lista-cartera');
        if (cartera.items.length === 0) {
            body.innerHTML = '<tr><td class="text-center py-4 text-muted">Sin cuentas pendientes</td></tr>';
        } else {
            body.innerHTML = cartera.items.map(i => `
                <tr>
                    <td class="ps-3">
                        <div class="fw-bold">${i.entidad}</div>
                        <div class="text-muted" style="font-size: 0.65rem;">Desde: ${i.fecha}</div>
                    </td>
                    <td class="text-end pe-3 fw-bold text-danger">${fmt(i.saldo)}</td>
                </tr>
            `).join('');
        }
        document.getElementById('total-cartera').innerText = fmt(cartera.total);
    }

    function renderPasivos(pasivos) {
        document.getElementById('total-pasivos').innerText = fmt(pasivos.total);
        const body = document.getElementById('table-pasivos');
        if (pasivos.items.length === 0) {
            body.innerHTML = '<tr><td class="text-center py-4 text-muted">Sin deudas pendientes</td></tr>';
        } else {
            body.innerHTML = pasivos.items.map(i => `
                <tr>
                    <td class="ps-3">
                        <div class="fw-bold">${i.entidad}</div>
                        <div class="text-muted" style="font-size: 0.65rem;">Fecha: ${i.fecha}</div>
                    </td>
                    <td class="text-end pe-3 fw-bold text-danger">${fmt(i.saldo)}</td>
                </tr>
            `).join('');
        }
    }

    function renderPatrimonio(neto) {
        document.getElementById('patrimonio-neto').innerText = fmt(neto);
    }

    function renderResultados(res) {
        document.getElementById('kpi-ganancia-neta').innerText = fmt(res.ganancia_neta);
        document.getElementById('subtotal-ingresos').innerText = fmt(res.ingresos.total);
        document.getElementById('subtotal-egresos').innerText = fmt(res.egresos.total);

        const tableIngresos = document.getElementById('table-ingresos');
        const itemsIng = Object.entries(res.ingresos.desglose);
        tableIngresos.innerHTML = itemsIng.length ? itemsIng.map(([cat, monto]) => `
            <tr><td class="ps-4">${cat}</td><td class="text-end pe-4 fw-bold text-success">+ ${fmt(monto)}</td></tr>
        `).join('') : '<tr><td colspan="2" class="text-center py-3 text-muted">Sin ingresos</td></tr>';

        const tableEgresos = document.getElementById('table-egresos');
        const itemsEgr = Object.entries(res.egresos.desglose);
        tableEgresos.innerHTML = itemsEgr.length ? itemsEgr.map(([cat, monto]) => `
            <tr><td class="ps-4">${cat}</td><td class="text-end pe-4 fw-bold text-danger">- ${fmt(monto)}</td></tr>
        `).join('') : '<tr><td colspan="2" class="text-center py-3 text-muted">Sin egresos</td></tr>';

        const status = document.getElementById('ganancia-status');
        if (res.ganancia_neta >= 0) {
            status.innerHTML = '<span class="badge bg-success-subtle text-success px-3 py-2"><i class="bi bi-caret-up-fill"></i> SALDO POSITIVO</span>';
        } else {
            status.innerHTML = '<span class="badge bg-danger-subtle text-danger px-3 py-2"><i class="bi bi-caret-down-fill"></i> DÃ‰FICIT FINANCIERO</span>';
        }
    }

    function renderRentabilidad(data, utilidadTotal) {
        const body = document.getElementById('table-rentabilidad');
        document.getElementById('utilidad-bruta-total').innerText = `Utilidad Bruta (Ventas - Costos): ${fmt(utilidadTotal)}`;

        if (data.length === 0) {
            body.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No hay datos</td></tr>';
            return;
        }

        body.innerHTML = data.map(i => `
            <tr>
                <td class="ps-4 fw-bold">${i.nombre}</td>
                <td class="text-center">${i.cantidad}</td>
                <td class="text-end text-muted">${fmt(i.total_venta)}</td>
                <td class="text-end text-muted">${fmt(i.total_costo)}</td>
                <td class="text-end pe-4 fw-bold text-primary">${fmt(i.ganancia)}</td>
            </tr>
        `).join('');
    }

    window.cargarBalance = cargarBalance;
    cargarBalance();
</script>
{% endblock %}
