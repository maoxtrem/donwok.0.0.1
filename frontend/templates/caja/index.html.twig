{% extends 'base.html.twig' %}

{% block title %}Caja Diaria - DonWok{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h2 class="fw-bold m-0 text-dark">Arqueo Diario</h2>
            <p class="text-muted mb-0">Movimientos pendientes de consolidación</p>
        </div>
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="dw-card px-4 py-2 text-center border-start border-4 border-primary">
                <small class="text-muted fw-bold d-block" style="font-size: 0.65rem; letter-spacing: 0.5px;">SALDO ESTIMADO</small>
                <h4 class="fw-bold m-0 text-primary" id="balance-total">$0.00</h4>
            </div>
            <button id="btn-cerrar-caja" class="dw-btn-primary text-white fw-bold shadow-sm" onclick="realizarCierreCaja()">
                <i class="bi bi-safe-fill me-2"></i> REALIZAR CIERRE DE CAJA
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- SECCIÓN INGRESOS -->
        <div class="col-lg-7">
            <div class="dw-card shadow-sm overflow-hidden h-100 border-0">
                <div class="p-3 bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold"><i class="bi bi-plus-circle me-2"></i> INGRESOS (VENTAS / CRÉDITOS)</h6>
                    <span class="badge bg-white text-success fw-bold" id="total-ingresos-badge" style="font-size: 0.9rem;">$0.00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light small">
                            <tr>
                                <th class="ps-4 py-3 text-muted fw-bold">Detalle</th>
                                <th class="py-3 text-muted fw-bold">Fecha</th>
                                <th class="text-end py-3 text-muted fw-bold">Total</th>
                                <th class="pe-4 text-center py-3 text-muted fw-bold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="facturas-emitidas-list">
                            <tr><td colspan="4" class="text-center py-5 text-muted">Cargando ingresos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SECCIÓN EGRESOS -->
        <div class="col-lg-5">
            <div class="dw-card shadow-sm overflow-hidden h-100 border-0">
                <div class="p-3 bg-danger text-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold"><i class="bi bi-dash-circle me-2"></i> EGRESOS (GASTOS / PAGOS)</h6>
                    <span class="badge bg-white text-danger fw-bold" id="total-egresos-badge" style="font-size: 0.9rem;">$0.00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light small">
                            <tr>
                                <th class="ps-4 py-3 text-muted fw-bold">Concepto</th>
                                <th class="text-end py-3 text-muted fw-bold">Monto</th>
                                <th class="pe-4 text-center py-3 text-muted fw-bold"></th>
                            </tr>
                        </thead>
                        <tbody id="egresos-pendientes-list">
                            <tr><td colspan="3" class="text-center py-5 text-muted">Cargando egresos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle -->
<div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header bg-light border-0 py-3" style="border-radius: 20px 20px 0 0;">
                <h5 class="modal-title fw-bold">Detalle de Factura <span id="detalle-nro" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="list-group list-group-flush" id="detalle-items-list"></ul>
                <div class="p-4 bg-light d-flex justify-content-between align-items-center" style="border-radius: 0 0 20px 20px;">
                    <span class="fw-bold text-secondary">TOTAL FACTURA</span>
                    <span class="h4 fw-bold text-dark m-0" id="detalle-total"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script type="module">
    import CoreAPI from '/js/core.js';
    const api = new CoreAPI();
    let currentFacturas = [];
    let currentAbonos = [];
    let currentEgresos = [];

    async function cargarDatos() {
        try {
            const [ingresosData, egresos] = await Promise.all([
                api.get('/caja/facturas-emitidas'),
                api.get('/caja/egresos-pendientes')
            ]);
            currentFacturas = ingresosData.facturas;
            currentAbonos = ingresosData.abonos;
            currentEgresos = egresos;
            
            renderIngresos();
            renderEgresos(egresos);
            actualizarBalance();
        } catch (err) { console.error(err); }
    }

    function renderIngresos() {
        const body = document.getElementById('facturas-emitidas-list');
        if (currentFacturas.length === 0 && currentAbonos.length === 0) {
            body.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">No hay ingresos hoy</td></tr>';
            return;
        }

        let html = '';
        
        // Renderizar Facturas
        html += currentFacturas.map(f => `
            <tr>
                <td class="ps-4 fw-bold text-primary">${f.numeroFactura}</td>
                <td class="text-muted small">${f.fecha}</td>
                <td class="text-end fw-bold">$${parseFloat(f.total).toFixed(2)}</td>
                <td class="pe-4 text-center">
                    <button class="btn btn-outline-primary btn-sm rounded-circle" onclick="window.verDetalle(${f.id})"><i class="bi bi-eye"></i></button>
                    <button class="btn btn-outline-danger btn-sm rounded-circle" onclick="window.anularFactura(${f.id})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');

        // Renderizar Abonos (Cobros)
        html += currentAbonos.map(a => `
            <tr class="bg-light-subtle">
                <td class="ps-4 fw-bold text-success">${a.tipo_label || 'COBRO'}: ${a.entidad}</td>
                <td class="text-muted small">${a.fecha}</td>
                <td class="text-end fw-bold text-success">$${parseFloat(a.monto).toFixed(2)}</td>
                <td class="pe-4 text-center text-muted small">Abono / Capital</td>
            </tr>
        `).join('');

        body.innerHTML = html;
    }

    function renderEgresos(egresos) {
        const body = document.getElementById('egresos-pendientes-list');
        if (!egresos || egresos.length === 0) {
            body.innerHTML = '<tr><td colspan="3" class="text-center py-5 text-muted">No hay egresos registrados</td></tr>';
            return;
        }

        body.innerHTML = egresos.map(e => `
            <tr>
                <td class="ps-4">
                    <div class="fw-bold small">${e.concepto}</div>
                    <div class="text-muted" style="font-size: 0.7rem;">${e.categoria} - ${e.cuenta}</div>
                </td>
                <td class="text-end text-danger fw-bold">$${parseFloat(e.monto).toFixed(2)}</td>
                <td class="pe-4 text-center">
                    ${e.tipo === 'ABONO_PAGO' ? '<i class="bi bi-lock text-muted" title="Pago de deuda"></i>' : `
                    <button class="btn btn-link text-danger btn-sm p-0" onclick="window.eliminarEgresoCola(${e.id}, '${e.tipo}')">
                        <i class="bi bi-x-circle"></i>
                    </button>`}
                </td>
            </tr>
        `).join('');
    }

    function actualizarBalance() {
        const totalIngresos = currentFacturas.reduce((sum, f) => sum + parseFloat(f.total), 0) + 
                             currentAbonos.reduce((sum, a) => sum + parseFloat(a.monto), 0);
        const totalEgresos = currentEgresos.reduce((sum, e) => sum + parseFloat(e.monto), 0);
        const balance = totalIngresos - totalEgresos;

        document.getElementById('total-ingresos-badge').innerText = `$${totalIngresos.toFixed(2)}`;
        document.getElementById('total-egresos-badge').innerText = `$${totalEgresos.toFixed(2)}`;
        document.getElementById('balance-total').innerText = `$${balance.toFixed(2)}`;
        
        document.getElementById('btn-cerrar-caja').disabled = (totalIngresos === 0 && totalEgresos === 0);
    }

    window.eliminarEgresoCola = async (id, tipo) => {
        const res = await Swal.fire({ title: '¿Eliminar de la cola?', text: "Este egreso se borrará permanentemente.", icon: 'warning', showCancelButton: true });
        if (res.isConfirmed) {
            const endpoint = (tipo === 'PRESTAMO' || tipo === 'PRESTAMO_NUEVO') ? `/caja/prestamos-cola/${id}` : `/caja/egresos/${id}`;
            await api.delete(endpoint);
            cargarDatos();
        }
    };

    window.anularFactura = async (id) => {
        const res = await Swal.fire({ title: '¿Anular factura?', text: "No contará para el cierre.", icon: 'warning', showCancelButton: true });
        if (res.isConfirmed) {
            await api.post(`/caja/facturas/${id}/anular`);
            cargarDatos();
        }
    };

    window.verDetalle = (id) => {
        const f = currentFacturas.find(fact => fact.id === id);
        if (!f) return;
        
        document.getElementById('detalle-nro').innerText = f.numeroFactura;
        document.getElementById('detalle-total').innerText = `$${parseFloat(f.total).toFixed(2)}`;
        
        const list = document.getElementById('detalle-items-list');
        list.innerHTML = f.items.map(item => `
            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <div><div class="fw-bold">${item.producto}</div><small class="text-muted">$${parseFloat(item.precio).toFixed(2)} x ${item.cantidad}</small></div>
                <span class="fw-bold">$${(parseFloat(item.precio) * item.cantidad).toFixed(2)}</span>
            </li>
        `).join('');
        
        const modalEl = document.getElementById('modalDetalle');
        let modal = bootstrap.Modal.getInstance(modalEl);
        if (!modal) {
            modal = new bootstrap.Modal(modalEl);
        }
        modal.show();
    };

    window.realizarCierreCaja = async () => {
        const totalIngresos = currentFacturas.reduce((sum, f) => sum + parseFloat(f.total), 0) + 
                             currentAbonos.reduce((sum, a) => sum + parseFloat(a.monto), 0);
        const totalEgresos = currentEgresos.reduce((sum, e) => sum + parseFloat(e.monto), 0);
        
        const res = await Swal.fire({
            title: 'Confirmar Cierre',
            html: `<div class="text-start">Ingresos Totales: <b>$${totalIngresos.toFixed(2)}</b><br>Egresos Totales: <b>$${totalEgresos.toFixed(2)}</b><hr>Balance: <b class="text-primary h4">$${(totalIngresos - totalEgresos).toFixed(2)}</b></div>`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Procesar Cierre Masivo'
        });

        if (res.isConfirmed) {
            const result = await api.post('/caja/cerrar');
            Swal.fire('¡Cierre Exitoso!', 'Los movimientos se han guardado en el historial.', 'success').then(() => {
                window.location.href = '/caja/movimientos';
            });
        }
    };

    cargarDatos();
</script>
{% endblock %}
